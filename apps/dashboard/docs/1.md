## Test Plan: Permission System

### Phase 1 — Default Policy (No Restrictions)

With no policy configured, all commands should execute immediately without approval.

| #   | Tool   | Args                      | CWD | Expected                            |
| --- | ------ | ------------------------- | --- | ----------------------------------- |
| 1   | `echo` | `hello world`             |     | Allow — immediate execution, exit 0 |
| 2   | `ls`   | `-la /tmp`                |     | Allow — immediate execution         |
| 3   | `curl` | `https://httpbin.org/get` |     | Allow — no domain restrictions      |

---

### Phase 2 — Set Allowed Tools (Whitelist)

**Policy panel**: set `allowed_tools` = `["echo", "ls", "cat"]`

| #   | Tool      | Args                      | CWD | Expected                                                      |
| --- | --------- | ------------------------- | --- | ------------------------------------------------------------- |
| 4   | `echo`    | `allowed tool`            |     | Allow — in whitelist                                          |
| 5   | `ls`      | `/tmp`                    |     | Allow — in whitelist                                          |
| 6   | `python3` | `-c "print('hi')"`        |     | **NeedsApproval** — "tool 'python3' is not in the allow list" |
| 7   | `curl`    | `https://httpbin.org/get` |     | **NeedsApproval** — not in whitelist                          |

For #6: click **Approve** in Approvals panel → should execute and return output For #7: click **Deny** in Approvals panel → should show "rejected"

---

### Phase 3 — Remember Approval

| #   | Tool      | Args                       | CWD | Expected                                       |
| --- | --------- | -------------------------- | --- | ---------------------------------------------- |
| 8   | `python3` | `-c "print('remembered')"` |     | **NeedsApproval** — click **Remember**         |
| 9   | `python3` | `-c "print('auto')"`       |     | **Allow** — session memory, no approval needed |

---

### Phase 4 — Denied Tools (Hard Block)

**Policy panel**: add `denied_tools` = `["rm", "shutdown"]`

| #   | Tool       | Args                  | CWD | Expected                                        |
| --- | ---------- | --------------------- | --- | ----------------------------------------------- |
| 10  | `rm`       | `-rf /tmp/test-ahand` |     | **Deny** — hard reject, no approval opportunity |
| 11  | `shutdown` | `-h now`              |     | **Deny** — hard reject                          |
| 12  | `echo`     | `still works`         |     | Allow — in allowed_tools                        |

---

### Phase 5 — Denied Paths

**Policy panel**: add `denied_paths` = `["/etc", "/usr"]`

| #   | Tool  | Args         | CWD          | Expected                             |
| --- | ----- | ------------ | ------------ | ------------------------------------ |
| 13  | `ls`  | `-la`        | `/tmp`       | Allow — path not denied              |
| 14  | `ls`  | `-la`        | `/etc`       | **Deny** — cwd matches denied_paths  |
| 15  | `cat` | `/etc/hosts` | `/etc/nginx` | **Deny** — cwd prefix matches `/etc` |

---

### Phase 6 — Domain Restrictions

**Policy panel**: set `allowed_domains` = `["github.com", "httpbin.org"]`

| #   | Tool   | Args                                 | CWD    | Expected                                                                                    |
| --- | ------ | ------------------------------------ | ------ | ------------------------------------------------------------------------------------------- |
| 16  | `curl` | `https://httpbin.org/get`            |        | **NeedsApproval** (curl not in allowed_tools) then Allow if approved; domain is whitelisted |
| 17  | `curl` | `https://evil.com/payload`           |        | **NeedsApproval** — domain `evil.com` not in allowed_domains                                |
| 18  | `git`  | `clone https://github.com/user/repo` | `/tmp` | **NeedsApproval** (git not in allowed_tools); domain `github.com` is whitelisted            |
| 19  | `curl` | `https://example.com/api`            |        | **NeedsApproval** — domain `example.com` not allowed                                        |

For #17: **Deny** → verify hard rejection For #18: **Remember** → verify `git` + `github.com` both memorized

---

### Phase 7 — Verify Remember with Domains

| #   | Tool  | Args                                  | CWD    | Expected                                                                |
| --- | ----- | ------------------------------------- | ------ | ----------------------------------------------------------------------- |
| 20  | `git` | `clone https://github.com/other/repo` | `/tmp` | **Allow** — `git` + `github.com` remembered from #18                    |
| 21  | `git` | `clone https://gitlab.com/user/repo`  | `/tmp` | **NeedsApproval** — `gitlab.com` not remembered, not in allowed_domains |

---

### Phase 8 — Policy Update (Dynamic)

**Policy panel**: add `echo` to `denied_tools`

| #   | Tool   | Args                   | CWD | Expected                                        |
| --- | ------ | ---------------------- | --- | ----------------------------------------------- |
| 22  | `echo` | `should be denied now` |     | **Deny** — denied_tools overrides allowed_tools |

**Policy panel**: remove `echo` from `denied_tools`, remove from `allowed_tools`

| #   | Tool   | Args            | CWD | Expected                                                          |
| --- | ------ | --------------- | --- | ----------------------------------------------------------------- |
| 23  | `echo` | `what happens?` |     | **NeedsApproval** — not in allowed_tools (whitelist still active) |

---

### Phase 9 — Approval Timeout

**Policy panel**: set `approval_timeout_secs` = `5` (5 seconds)

| #   | Tool     | Args | CWD | Expected                                                                       |
| --- | -------- | ---- | --- | ------------------------------------------------------------------------------ |
| 24  | `whoami` |      |     | **NeedsApproval** — don't click anything, wait 5s → auto-rejected with timeout |

---

### Phase 10 — Reset & Verify

**Policy panel**: clear all rules (empty allowed_tools, denied_tools, denied_paths, allowed_domains, reset timeout to 86400)

| #   | Tool   | Args                   | CWD | Expected                                |
| --- | ------ | ---------------------- | --- | --------------------------------------- |
| 25  | `echo` | `back to normal`       |     | Allow — default policy, no restrictions |
| 26  | `curl` | `https://anything.com` |     | Allow — no domain restrictions          |

---

### Summary of Coverage

| Policy Feature             | Test Cases     |
| -------------------------- | -------------- |
| Default (no policy)        | #1-3           |
| allowed_tools whitelist    | #4-7           |
| Approve / Deny buttons     | #6, #7         |
| Remember (session memory)  | #8-9, #18, #20 |
| denied_tools (hard block)  | #10-11, #22    |
| denied_paths (cwd check)   | #13-15         |
| allowed_domains (network)  | #16-19         |
| Domain + tool memory combo | #20-21         |
| Dynamic policy update      | #22-23         |
| Approval timeout           | #24            |
| Policy reset               | #25-26         |
