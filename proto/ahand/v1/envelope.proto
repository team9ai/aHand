syntax = "proto3";

package ahand.v1;

// Envelope wraps all messages on the wire (WS and IPC).
message Envelope {
  string device_id = 1;
  string trace_id  = 2;
  string msg_id    = 3;
  uint64 seq       = 4;
  uint64 ack       = 5;
  uint64 ts_ms     = 6;

  oneof payload {
    Hello            hello             = 10;
    JobRequest       job_request       = 11;
    JobEvent         job_event         = 12;
    JobFinished      job_finished      = 13;
    JobRejected      job_rejected      = 14;
    CancelJob        cancel_job        = 15;
    ApprovalRequest  approval_request  = 16;
    ApprovalResponse approval_response = 17;
    PolicyQuery      policy_query      = 18;  // reserved for Mode 5 (preset)
    PolicyState      policy_state      = 19;  // reserved for Mode 5 (preset)
    PolicyUpdate     policy_update     = 20;  // reserved for Mode 5 (preset)
    SetSessionMode   set_session_mode  = 21;
    SessionState     session_state     = 22;
    SessionQuery     session_query     = 23;
  }
}

// Hello - initial handshake after WS connection.
message Hello {
  string version    = 1;
  string hostname   = 2;
  string os         = 3;
  repeated string capabilities = 4;
  uint64 last_ack   = 5;  // on reconnect, the highest seq received from peer
}

// JobRequest - cloud asks local to execute a tool.
message JobRequest {
  string job_id = 1;
  string tool   = 2;  // executable name, e.g. "rg", "git"
  repeated string args = 3;
  string cwd    = 4;
  map<string, string> env = 5;
  uint64 timeout_ms = 6;
}

// JobEvent - streaming output from a running job.
message JobEvent {
  string job_id = 1;

  oneof event {
    bytes  stdout_chunk = 2;
    bytes  stderr_chunk = 3;
    uint32 progress     = 4;  // 0-100
  }
}

// JobFinished - job completed (success or failure).
message JobFinished {
  string job_id    = 1;
  int32  exit_code = 2;
  string error     = 3;  // empty on success
}

// JobRejected - local policy rejected the job.
message JobRejected {
  string job_id = 1;
  string reason = 2;
}

// CancelJob - request to cancel a running job.
message CancelJob {
  string job_id = 1;
}

// ApprovalRequest - daemon asks user to approve a job (strict mode).
message ApprovalRequest {
  string job_id  = 1;
  string tool    = 2;
  repeated string args = 3;
  string cwd     = 4;
  string reason  = 5;
  repeated string detected_domains = 6;
  uint64 expires_ms  = 7;  // absolute timestamp when this request expires
  string caller_uid  = 8;  // who submitted the job (IPC="uid:N", WS="cloud")
  repeated RefusalContext previous_refusals = 9;  // recent refusals for the same tool (24h context)
}

// ApprovalResponse - user responds to an approval request.
message ApprovalResponse {
  string job_id   = 1;
  bool   approved = 2;
  bool   remember = 3;  // reserved for Mode 5 (preset)
  string reason   = 4;  // refusal reason (stored for 24h as context)
}

// PolicyQuery - request the current policy configuration.
message PolicyQuery {}

// PolicyState - snapshot of the current policy (response to query or update).
message PolicyState {
  repeated string allowed_tools = 1;
  repeated string denied_tools  = 2;
  repeated string denied_paths  = 3;
  repeated string allowed_domains = 4;
  uint64 approval_timeout_secs = 5;
}

// PolicyUpdate - incremental policy modification. Empty lists = no change.
// Reserved for Mode 5 (preset).
message PolicyUpdate {
  repeated string add_allowed_tools      = 1;
  repeated string remove_allowed_tools   = 2;
  repeated string add_denied_tools       = 3;
  repeated string remove_denied_tools    = 4;
  repeated string add_allowed_domains    = 5;
  repeated string remove_allowed_domains = 6;
  repeated string add_denied_paths       = 7;
  repeated string remove_denied_paths    = 8;
  uint64 approval_timeout_secs = 9;  // 0 = don't change
}

// ── Session Mode System ─────────────────────────────────────────

// Session mode controls how commands from a specific caller are handled.
enum SessionMode {
  SESSION_MODE_INACTIVE    = 0;  // default — reject all, prompt user to activate
  SESSION_MODE_STRICT      = 1;  // every command requires manual approval
  SESSION_MODE_TRUST       = 2;  // auto-approve, with inactivity timeout
  SESSION_MODE_AUTO_ACCEPT = 3;  // auto-approve, no timeout
}

// SetSessionMode - set the mode for a specific caller (cloud → daemon).
message SetSessionMode {
  string caller_uid        = 1;
  SessionMode mode         = 2;
  uint64 trust_timeout_mins = 3;  // 0 = use default (60 min)
}

// SessionState - current session state for a caller (daemon → cloud).
message SessionState {
  string caller_uid        = 1;
  SessionMode mode         = 2;
  uint64 trust_expires_ms  = 3;  // absolute timestamp, 0 = not applicable
  uint64 trust_timeout_mins = 4;
}

// SessionQuery - request session state (cloud → daemon).
message SessionQuery {
  string caller_uid = 1;  // empty = query all sessions
}

// RefusalContext - context from a recent refusal of the same tool.
message RefusalContext {
  string tool          = 1;
  string reason        = 2;
  uint64 refused_at_ms = 3;
}
